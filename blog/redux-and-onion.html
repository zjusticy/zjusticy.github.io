<!DOCTYPE html><html><head><link rel="icon" type="image/png" href="/favicon.png"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-164183122-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-164183122-1', {
              page_path: window.location.pathname,
            });
          </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Redux and the onion model: a simple guidance</title><meta name="description" content="Fundamental knowledge of redux and an simple but educational example for onion model"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/d1a15aec81db4f2eeb34.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d1a15aec81db4f2eeb34.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cbaae6e608cab26eeba6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cbaae6e608cab26eeba6.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-ddb8120628696eab2cf7.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.37f4a736348214b3ca94.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.cd0284e737cdbe1a0804.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-ac381f7de694df1ac072.js" as="script"/><link rel="preload" href="/_next/static/chunks/cb1608f2.a8b8abb6f1565b60835e.js" as="script"/><link rel="preload" href="/_next/static/chunks/275aa556a5034f679288ea31c9ede8d484e91f4a.a637e2ef2f3c7f61e3fc.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-b7d9cbac10da2d260a14.js" as="script"/></head><body><div id="__next"><div><nav class="layout_navbar__1zC8E" role="navigation" aria-label="main navigation"><div class="container"><div class="layout_navbarBrand__37nmK"><a class="layout_navbarItem__1LSrv" href="/"><svg width="36" height="36" viewBox="0 0 144 142" aria-hidden="true" fill="#000" class="svg-icon " xmlns="http://www.w3.org/2000/svg"><rect x="124" y="81" width="20" height="20" fill="black"></rect><rect x="124" y="102" width="20" height="20" fill="black"></rect><rect x="41" y="20" width="20" height="20" fill="black"></rect><rect x="83" y="20" width="20" height="20" fill="black"></rect><rect x="62" y="122" width="20" height="20" fill="black"></rect><rect x="124" y="60" width="20" height="20" fill="black"></rect><rect y="81" width="20" height="20" fill="black"></rect><rect y="102" width="20" height="20" fill="black"></rect><rect x="62" width="20" height="20" fill="black"></rect><rect x="41" y="122" width="20" height="20" fill="black"></rect><rect x="104" y="122" width="20" height="20" fill="black"></rect><rect x="104" y="40" width="20" height="20" fill="black"></rect><rect x="83" y="122" width="20" height="20" fill="black"></rect><rect x="20" y="40" width="20" height="20" fill="black"></rect><rect x="20" y="122" width="20" height="20" fill="black"></rect><rect y="60" width="20" height="20" fill="black"></rect></svg></a><a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div id="navbarBasicExample" class="layout_navbarMenu__1NXMa"><div class="layout_navEndSettings__227S4 layout_navbarEnd__3jMCV"><a class="layout_navbarItem__1LSrv layout_moreMargin__2KGfE layout_nonBorder__OGLUi" aria-label="Home page" href="/">Home</a><a class="layout_navbarItem__1LSrv layout_moreMargin__2KGfE layout_addBorder__2Y_EI" aria-label="Blog page" href="/blog">Blog</a><a class="layout_navbarItem__1LSrv layout_moreMargin__2KGfE layout_nonBorder__OGLUi" aria-label="About the author" href="/about">About</a></div></div></div></nav><main><div class="container"><div class="isBlog"><nav class="breadcrumb is-medium" aria-label="breadcrumbs"><ul><li><a href="/blog">Blog</a></li><li class="is-active"><span></span></li></ul></nav><article><h1 class="isBlog-title is-2p5">Redux and the onion model: a simple guidance</h1><span class="dateStyle-2">20 Jul, 2020</span><div class="content"><div><h2>The prerequisite</h2>
<h3>1. Javascript</h3>
<h3>2. Compose</h3>
<blockquote>
<p>Composes functions from right to left.</p>
</blockquote>
<p>Combining functions, connecting functions in series for execution. Just like domino, the first function is pushed down, and other functions are also executed.</p>
<p>First we look at a simple example.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Equation: f(x) = (x + 100) * 2 - 100</span>
<span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token parameter">a</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">multiple</span> <span class="token operator">=</span> <span class="token parameter">m</span> <span class="token arrow operator">=></span> m <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">subtract</span> <span class="token operator">=</span> <span class="token parameter">s</span> <span class="token arrow operator">=></span> s <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">// Deeply nested function</span>
<span class="token function">subtract</span><span class="token punctuation">(</span><span class="token function">multiple</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//500</span>
</code></pre>
<p>The execution result of the above example is: 500</p>
<p>Compose actually implements the concatenation of all functions through the reduce () method. The deep nested function mode is not directly used, which enhances the code readability.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token parameter">arg</span> <span class="token arrow operator">=></span> arg
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>funcs<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> funcs<span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>args</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token spread operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>compose(subtract, multiple, add)(200);
</code></pre>
<h3>3. Currying</h3>
<blockquote>
<p>Currying is the technique of translating the evaluation of a function that takes multiple arguments into evaluating a sequence of functions, each with a single argument</p>
</blockquote>
<p>Let the codes explain themselves:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Equation: f(x, y, z) = (x + 100) * y - z;</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> y <span class="token operator">-</span> z<span class="token punctuation">;</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Can be implemented as below </span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> y <span class="token operator">-</span> z<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>


<span class="token comment">// The implementation of Currying uses a single </span>
<span class="token comment">// parameter anonymous function wrapped in </span>
<span class="token comment">// layers to implement the same function above</span>

<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token arrow operator">=></span> <span class="token parameter">y</span> <span class="token arrow operator">=></span> <span class="token parameter">z</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> y <span class="token operator">-</span> z<span class="token punctuation">;</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//500</span>
</code></pre>
<ul>
<li>Currying only accepts single parameter.</li>
</ul>
<h2>Why dispatch needs middleware</h2>
<pre><code>
 --------  callack   ----------  action
| Button | ------>  | Dispatch | ------           
 --------            ----------       |
                                      |
                                      |
 --------   state    ----------       |
|  View  | &#x3C;------  |  Reducer | &#x3C;-----           
 --------            ----------             
         
</code></pre>
<p>The above figure shows a simple synchronous data flow scenario in redux. After clicking the button, an action is dispatched in the callback. After the reducer receives the action, it updates the state and notifies the view to re-render. One-way data flow, it looks no problem. However, if you need to print every action information for debugging, you have to change the dispatch or reducer code to make it have the function of printing the log; for example, after clicking the button, you need to go to the server to request data first. In order to re-render the view, at this time we hope that the dispatch or reducer has the function of asynchronous request; for example, after asynchronously requesting the data, print a log, request the data again, print the log again, and render ...</p>
<p>In the face of various business needs, simply modifying the code of dispatch or reducer is obviously not universal. What we need is a combinable, freely pluggable plug-in mechanism. This redux draws lessons from onion model in  <a href="https://link.zhihu.com/?target=http%3A//koa.bootcss.com/">koa</a> to solve the problem. Koa is a NodeJS framework for building web applications.</p>
<h2>Source code analysis of “applyMiddleware”</h2>
<p>The code of applyMiddleware function is short, but it is the most essence of Redux. It allows Redux to insert the side effects in the process of action transmission while maintaining "self-functional purity".</p>
<p>A piece of code is used for example before the diagram. We will understand applyMiddleware's onion model mechanism around this code:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token constant">M1</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// M1 side effect</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'A middleware1 starts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'B middleware1 ends'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token constant">M2</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// M2 side effect</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'C middleware2 starts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'D middleware2 ends'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token constant">M3</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// M3 side effect</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'E middleware3 starts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'F middleware3 ends'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token string">'MIDDLEWARE_TEST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'======= G ======='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> store <span class="token operator">=</span> <span class="token maybe-class-name">Redux</span><span class="token punctuation">.</span><span class="token method function property-access">createStore</span><span class="token punctuation">(</span>
  reducer<span class="token punctuation">,</span>
  <span class="token maybe-class-name">Redux</span><span class="token punctuation">.</span><span class="token method function property-access">applyMiddleware</span><span class="token punctuation">(</span>
    <span class="token constant">M1</span><span class="token punctuation">,</span>
    <span class="token constant">M2</span><span class="token punctuation">,</span>
    <span class="token constant">M3</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

store<span class="token punctuation">.</span><span class="token method function property-access">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'MIDDLEWARE_TEST'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The onion model of the above code is as follows:</p>
<pre><code>            --------------------------------------
            |            middleware1              |
            |    ----------------------------     |
            |    |       middleware2         |    |
            |    |    -------------------    |    |
            |    |    |  middleware3    |    |    |
            |    |    |                 |    |    |
          next next next  ———————————   |    |    |
dispatch  —————————————> |  reducer  | — Ending ->|
nextState &#x3C;————————————— |     G     |  |    |    |
            | A  | C  | E ——————————— F |  D |  B |
            |    |    |                 |    |    |
            |    |    -------------------    |    |
            |    ----------------------------     |
            --------------------------------------

Sequence   A -> C -> E -> G -> F -> D -> B
          \---------------/   \----------/
                  ↓                ↓
            Update state       Ending process
</code></pre>
<p>We refer to each part of middleware that actually brings side effects (here side effects are good, all we need is side effects of middleware), called <code>M? Side effects</code>, and its function signature is <code>(action) => {}</code>.</p>
<p>For this sample code, the running process of the onion model of Redux middleware is:</p>
<p>The user dispatches action → action to pass the M1 side effects → print A → execute M1 next (this next points to M2 side effects) → print C → execute M2 next (this next points to M3 side effects) → print E → execute M3 next (this next Point to <code>store.dispatch</code>) → Return to M3 side effect printing F after execution completion → Return to M2 print E → Return to M1 side effect printing B-> dispatch execution is completed.</p>
<p>So the question is, how does the next of M1 M2 M3 bind?</p>
<p>Answer: Currying binding, the complete function signature of a middleware is <code>store => next => action {}</code>, but the last executed onion model only has action left, and the outer store and next go through Curry The corresponding function is bound, and then look at how next is bound.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token spread operator">...</span>args<span class="token punctuation">)</span>
<span class="token keyword">let</span> dispatch <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token property-access">dispatch</span>
<span class="token keyword">let</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
    getState<span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token property-access">getState</span><span class="token punctuation">,</span>
    <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>args</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token spread operator">...</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token arrow operator">=></span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// bind {dispatch和getState}</span>
dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token spread operator">...</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token punctuation">)</span> <span class="token comment">// bind next</span>
</code></pre>
<p>The key point is the two bingding sentences. Let ’s look at the first sentence:</p>
<pre class="language-js"><code class="language-js">chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token arrow operator">=></span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// bind {dispatch和getState}</span>
</code></pre>
<p>Why bind <code>getState</code>? Because middleware needs to get the current state at any time. Why should it get <code>dispatch</code>? Because there may be actions dispatching (such as redux-thunk) in the middleware, currying this map function binds <code>getState</code> and <code>dispatch</code>.</p>
<p>Next  <code>dispatch = compose(...chain)(store.dispatch) </code>. The function of compose is, from right to left, the return value on the right is passed in as a parameter on the left, wrapped in layers, as we discussed above.</p>
<p>It is equivalent to:</p>
<pre class="language-js"><code class="language-js">dispatch <span class="token operator">=</span> <span class="token constant">MC1</span><span class="token punctuation">(</span><span class="token constant">MC2</span><span class="token punctuation">(</span><span class="token constant">MC3</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<p>MC is the element in the chain, yes, this is another currying.</p>
<p>At this point, the truth is clear. Dispatch made a small contribution and did two things: 1 . Binding next in each middleware. 2 . An interface is exposed for receiving actions.</p>
<h2>Detail</h2>
<p>After compose, all the middleware is connected in series, but there is still a problem we need to dig. Every middleware can access the store, which is the variable in middlewareAPI, so you can get the dispatch method of the store. Is there a difference to use <code>store.dispatch()</code> instead of <code>next()</code>?</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// The wrong version</span>

<span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span> 
  getState<span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token property-access">getState</span><span class="token punctuation">,</span> 
  dispatch<span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token property-access">dispatch</span> 
<span class="token punctuation">}</span>

<span class="token comment">// The correct version</span>

<span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span> 
  getState<span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token property-access">getState</span><span class="token punctuation">,</span> 
  <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>args</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token spread operator">...</span>args<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre>
<p>If directly written as <code>store.dispatch</code>, then dispatch an action in a middleware (except the last one, the last middleware is the original <code>store.dispatch</code>), such as redux-thunk:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createThunkMiddleware</span><span class="token punctuation">(</span><span class="token parameter">extraArgument</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token parameter">next</span> <span class="token arrow operator">=></span> <span class="token parameter">action</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> extraArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword control-flow">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It is to intercept the action with the function type. If this actionCreator is a fuction to fetch online data then dispatch a new action accordingly and we use <code>store.dispatch</code> instead of <code>dispatch = MC1(MC2(MC3(store.dispatch)))</code>, then this action has gone through <code>store.dispatch</code> without any middleware decoration, which is obviously not acceptable. The flow can be demonstrated as below:</p>
<pre><code>// The wrong version using store.dispatch

Sequence   A -> C -> E -> G -> F -> D -> B
                     |
                     ↓                
               dispatch action -> G


// The correct version using 
// dispatch = MC1(MC2(MC3(store.dispatch)))

Sequence   A -> C -> E -> G -> F -> D -> B
                     |
                     ↓                
               dispatch action -> A -> C -> E -> G ->...
</code></pre>
<h2>Reference</h2>
<ul>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/20597452">https://zhuanlan.zhihu.com/p/20597452</a></p>
</li>
<li>
<p><a href="https://github.com/kenberkeley/redux-simple-tutorial/blob/master/redux-advanced-tutorial.md">https://github.com/kenberkeley/redux-simple-tutorial/blob/master/redux-advanced-tutorial.md</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5859edb98d6d810065c8f28a">https://juejin.im/post/5859edb98d6d810065c8f28a</a></p>
</li>
</ul></div></div></article><div class="marginTop-2"><a>← Blog</a></div></div></div></main><footer class="layout_myFooter__JubIR"><div class="container"><div>Email me:     <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope" class="svg-inline--fa fa-envelope fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg> <a href="mailto:tzhu618@gmail.com">tzhu618@gmail.com</a></div><div class="layout_lastColor__ALfcM">© <!-- -->2021<!-- -->, Built with<!-- --> <a href="https://nextjs.org/">NextJs</a> and <a href="https://getbase.org">Base</a></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Redux and the onion model: a simple guidance","date":"2020-05-20T23:39:33.169Z","description":"Fundamental knowledge of redux and an simple but educational example for onion model","slug":"redux-and-onion","content":"\u003ch2\u003eThe prerequisite\u003c/h2\u003e\n\u003ch3\u003e1. Javascript\u003c/h3\u003e\n\u003ch3\u003e2. Compose\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eComposes functions from right to left.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eCombining functions, connecting functions in series for execution. Just like domino, the first function is pushed down, and other functions are also executed.\u003c/p\u003e\n\u003cp\u003eFirst we look at a simple example.\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// Equation: f(x) = (x + 100) * 2 - 100\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003eadd\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ea\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003emultiple\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token parameter\"\u003em\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e m \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003esubtract\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token parameter\"\u003es\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e s \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Deeply nested function\u003c/span\u003e\n\u003cspan class=\"token function\"\u003esubtract\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003emultiple\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e//500\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe execution result of the above example is: 500\u003c/p\u003e\n\u003cp\u003eCompose actually implements the concatenation of all functions through the reduce () method. The deep nested function mode is not directly used, which enhances the code readability.\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ecompose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003efuncs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efuncs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003elength\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token parameter\"\u003earg\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e arg\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efuncs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003elength\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e funcs\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e funcs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ereduce\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e b\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003ea\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003ecompose(subtract, multiple, add)(200);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e3. Currying\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eCurrying is the technique of translating the evaluation of a function that takes multiple arguments into evaluating a sequence of functions, each with a single argument\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eLet the codes explain themselves:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// Equation: f(x, y, z) = (x + 100) * y - z;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003efn\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ex\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e z\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e z\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Can be implemented as below \u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003efn\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ez\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \n      \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e z\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token comment\"\u003e// The implementation of Currying uses a single \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// parameter anonymous function wrapped in \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// layers to implement the same function above\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003efn\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ex\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ey\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ez\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ex \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e y \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e z\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e//500\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eCurrying only accepts single parameter.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eWhy dispatch needs middleware\u003c/h2\u003e\n\u003cpre\u003e\u003ccode\u003e\n --------  callack   ----------  action\n| Button | ------\u003e  | Dispatch | ------           \n --------            ----------       |\n                                      |\n                                      |\n --------   state    ----------       |\n|  View  | \u0026#x3C;------  |  Reducer | \u0026#x3C;-----           \n --------            ----------             \n         \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe above figure shows a simple synchronous data flow scenario in redux. After clicking the button, an action is dispatched in the callback. After the reducer receives the action, it updates the state and notifies the view to re-render. One-way data flow, it looks no problem. However, if you need to print every action information for debugging, you have to change the dispatch or reducer code to make it have the function of printing the log; for example, after clicking the button, you need to go to the server to request data first. In order to re-render the view, at this time we hope that the dispatch or reducer has the function of asynchronous request; for example, after asynchronously requesting the data, print a log, request the data again, print the log again, and render ...\u003c/p\u003e\n\u003cp\u003eIn the face of various business needs, simply modifying the code of dispatch or reducer is obviously not universal. What we need is a combinable, freely pluggable plug-in mechanism. This redux draws lessons from onion model in  \u003ca href=\"https://link.zhihu.com/?target=http%3A//koa.bootcss.com/\"\u003ekoa\u003c/a\u003e to solve the problem. Koa is a NodeJS framework for building web applications.\u003c/p\u003e\n\u003ch2\u003eSource code analysis of “applyMiddleware”\u003c/h2\u003e\n\u003cp\u003eThe code of applyMiddleware function is short, but it is the most essence of Redux. It allows Redux to insert the side effects in the process of action transmission while maintaining \"self-functional purity\".\u003c/p\u003e\n\u003cp\u003eA piece of code is used for example before the diagram. We will understand applyMiddleware's onion model mechanism around this code:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eM1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003estore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// M1 side effect\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'A middleware1 starts'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'B middleware1 ends'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eM2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003estore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// M2 side effect\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'C middleware2 starts'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'D middleware2 ends'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eM3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003estore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// M3 side effect\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'E middleware3 starts'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'F middleware3 ends'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ereducer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e action\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaction\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003etype\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token string\"\u003e'MIDDLEWARE_TEST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'======= G ======='\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e  \n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e store \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eRedux\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreateStore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n  reducer\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token maybe-class-name\"\u003eRedux\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eapplyMiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"token constant\"\u003eM1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token constant\"\u003eM2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token constant\"\u003eM3\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\nstore\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e type\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'MIDDLEWARE_TEST'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe onion model of the above code is as follows:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e            --------------------------------------\n            |            middleware1              |\n            |    ----------------------------     |\n            |    |       middleware2         |    |\n            |    |    -------------------    |    |\n            |    |    |  middleware3    |    |    |\n            |    |    |                 |    |    |\n          next next next  ———————————   |    |    |\ndispatch  —————————————\u003e |  reducer  | — Ending -\u003e|\nnextState \u0026#x3C;————————————— |     G     |  |    |    |\n            | A  | C  | E ——————————— F |  D |  B |\n            |    |    |                 |    |    |\n            |    |    -------------------    |    |\n            |    ----------------------------     |\n            --------------------------------------\n\nSequence   A -\u003e C -\u003e E -\u003e G -\u003e F -\u003e D -\u003e B\n          \\---------------/   \\----------/\n                  ↓                ↓\n            Update state       Ending process\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe refer to each part of middleware that actually brings side effects (here side effects are good, all we need is side effects of middleware), called \u003ccode\u003eM? Side effects\u003c/code\u003e, and its function signature is \u003ccode\u003e(action) =\u003e {}\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eFor this sample code, the running process of the onion model of Redux middleware is:\u003c/p\u003e\n\u003cp\u003eThe user dispatches action → action to pass the M1 side effects → print A → execute M1 next (this next points to M2 side effects) → print C → execute M2 next (this next points to M3 side effects) → print E → execute M3 next (this next Point to \u003ccode\u003estore.dispatch\u003c/code\u003e) → Return to M3 side effect printing F after execution completion → Return to M2 print E → Return to M1 side effect printing B-\u003e dispatch execution is completed.\u003c/p\u003e\n\u003cp\u003eSo the question is, how does the next of M1 M2 M3 bind?\u003c/p\u003e\n\u003cp\u003eAnswer: Currying binding, the complete function signature of a middleware is \u003ccode\u003estore =\u003e next =\u003e action {}\u003c/code\u003e, but the last executed onion model only has action left, and the outer store and next go through Curry The corresponding function is bound, and then look at how next is bound.\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e store \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateStore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e dispatch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e store\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edispatch\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e chain \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e middlewareAPI \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    getState\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e store\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003egetState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token function-variable function\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nchain \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e middlewares\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003emiddleware\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emiddlewareAPI\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// bind {dispatch和getState}\u003c/span\u003e\ndispatch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ecompose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003echain\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estore\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// bind next\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe key point is the two bingding sentences. Let ’s look at the first sentence:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003echain \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e middlewares\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003emiddleware\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003emiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emiddlewareAPI\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// bind {dispatch和getState}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhy bind \u003ccode\u003egetState\u003c/code\u003e? Because middleware needs to get the current state at any time. Why should it get \u003ccode\u003edispatch\u003c/code\u003e? Because there may be actions dispatching (such as redux-thunk) in the middleware, currying this map function binds \u003ccode\u003egetState\u003c/code\u003e and \u003ccode\u003edispatch\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eNext  \u003ccode\u003edispatch = compose(...chain)(store.dispatch) \u003c/code\u003e. The function of compose is, from right to left, the return value on the right is passed in as a parameter on the left, wrapped in layers, as we discussed above.\u003c/p\u003e\n\u003cp\u003eIt is equivalent to:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003edispatch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eMC1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eMC2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eMC3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estore\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMC is the element in the chain, yes, this is another currying.\u003c/p\u003e\n\u003cp\u003eAt this point, the truth is clear. Dispatch made a small contribution and did two things: 1 . Binding next in each middleware. 2 . An interface is exposed for receiving actions.\u003c/p\u003e\n\u003ch2\u003eDetail\u003c/h2\u003e\n\u003cp\u003eAfter compose, all the middleware is connected in series, but there is still a problem we need to dig. Every middleware can access the store, which is the variable in middlewareAPI, so you can get the dispatch method of the store. Is there a difference to use \u003ccode\u003estore.dispatch()\u003c/code\u003e instead of \u003ccode\u003enext()\u003c/code\u003e?\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// The wrong version\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e middlewareAPI \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \n  getState\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e store\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003egetState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \n  dispatch\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e store\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edispatch\u003c/span\u003e \n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// The correct version\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e middlewareAPI \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \n  getState\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e store\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003egetState\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \n  \u003cspan class=\"token function-variable function\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003edispatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token spread operator\"\u003e...\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf directly written as \u003ccode\u003estore.dispatch\u003c/code\u003e, then dispatch an action in a middleware (except the last one, the last middleware is the original \u003ccode\u003estore.dispatch\u003c/code\u003e), such as redux-thunk:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateThunkMiddleware\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eextraArgument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e dispatch\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e getState \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token parameter\"\u003enext\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token parameter\"\u003eaction\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etypeof\u003c/span\u003e action \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token string\"\u003e'function'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edispatch\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e getState\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e extraArgument\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003enext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt is to intercept the action with the function type. If this actionCreator is a fuction to fetch online data then dispatch a new action accordingly and we use \u003ccode\u003estore.dispatch\u003c/code\u003e instead of \u003ccode\u003edispatch = MC1(MC2(MC3(store.dispatch)))\u003c/code\u003e, then this action has gone through \u003ccode\u003estore.dispatch\u003c/code\u003e without any middleware decoration, which is obviously not acceptable. The flow can be demonstrated as below:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// The wrong version using store.dispatch\n\nSequence   A -\u003e C -\u003e E -\u003e G -\u003e F -\u003e D -\u003e B\n                     |\n                     ↓                \n               dispatch action -\u003e G\n\n\n// The correct version using \n// dispatch = MC1(MC2(MC3(store.dispatch)))\n\nSequence   A -\u003e C -\u003e E -\u003e G -\u003e F -\u003e D -\u003e B\n                     |\n                     ↓                \n               dispatch action -\u003e A -\u003e C -\u003e E -\u003e G -\u003e...\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eReference\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://zhuanlan.zhihu.com/p/20597452\"\u003ehttps://zhuanlan.zhihu.com/p/20597452\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/kenberkeley/redux-simple-tutorial/blob/master/redux-advanced-tutorial.md\"\u003ehttps://github.com/kenberkeley/redux-simple-tutorial/blob/master/redux-advanced-tutorial.md\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://juejin.im/post/5859edb98d6d810065c8f28a\"\u003ehttps://juejin.im/post/5859edb98d6d810065c8f28a\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"redux-and-onion"},"buildId":"Ezo2b6MmE7BuM5DA-6ixl","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-feb8a7604fa7fce626b2.js"></script><script src="/_next/static/chunks/main-ddb8120628696eab2cf7.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.37f4a736348214b3ca94.js" async=""></script><script src="/_next/static/chunks/commons.cd0284e737cdbe1a0804.js" async=""></script><script src="/_next/static/chunks/pages/_app-ac381f7de694df1ac072.js" async=""></script><script src="/_next/static/chunks/cb1608f2.a8b8abb6f1565b60835e.js" async=""></script><script src="/_next/static/chunks/275aa556a5034f679288ea31c9ede8d484e91f4a.a637e2ef2f3c7f61e3fc.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-b7d9cbac10da2d260a14.js" async=""></script><script src="/_next/static/Ezo2b6MmE7BuM5DA-6ixl/_buildManifest.js" async=""></script><script src="/_next/static/Ezo2b6MmE7BuM5DA-6ixl/_ssgManifest.js" async=""></script></body></html>